---
const { id = 'app-modal', title = 'Modal' } = Astro.props
---

<div
  id={id}
  data-modal-id={id}
  class="fixed inset-0 z-50 hidden items-center justify-center"
  role="dialog"
  aria-modal="true"
  aria-labelledby={`${id}-title`}
  aria-hidden="true"
>
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/50 opacity-0 transition-opacity duration-300" data-backdrop>
  </div>

  <!-- Panel del modal -->
  <div
    class="relative mx-auto w-[92%] max-w-lg rounded-2xl bg-white p-6 shadow-xl outline-none opacity-0 translate-y-6 scale-95 transition-all duration-300"
    tabindex="-1"
    data-panel
  >
    <header class="flex items-start justify-between gap-4">
      <h2 id={`${id}-title`} class="text-3xl font-semibold text-red-800">{title}</h2>
      <button
        type="button"
        class="inline-flex h-9 w-9 items-center justify-center rounded-full border border-gray-200 text-gray-600 hover:bg-gray-50 cursor-pointer"
        aria-label="Cerrar modal"
        data-close
      >
        ✕
      </button>
    </header>

    <div class="mt-4 text-gray-700">
      <slot />
    </div>

  </div>
</div>

<script type="module">
  function openModal(id) {
    const root = document.querySelector(`[data-modal-id="${id}"]`)
    if (!root) return
    const backdrop = root.querySelector('[data-backdrop]')
    const panel = root.querySelector('[data-panel]')

    root.classList.remove('hidden')
    root.classList.add('flex')
    root.setAttribute('aria-hidden', 'false')
    document.documentElement.classList.add('overflow-y-hidden')

    void root.offsetWidth // forzar reflujo

    backdrop.classList.remove('opacity-0')
    panel.classList.remove('opacity-0', 'translate-y-6', 'scale-95')
  }

  function closeModal(root) {
    const backdrop = root.querySelector('[data-backdrop]')
    const panel = root.querySelector('[data-panel]')

    backdrop.classList.add('opacity-0')
    panel.classList.add('opacity-0', 'translate-y-6', 'scale-95')

    setTimeout(() => {
      root.classList.add('hidden')
      root.classList.remove('flex')
      root.setAttribute('aria-hidden', 'true')
      document.documentElement.classList.remove('overflow-y-hidden')
    }, 300) // duración igual a Tailwind duration-300
  }

  document.addEventListener('click', (e) => {
    const openBtn = e.target.closest('[data-open-modal]')
    if (openBtn) {
      const id = openBtn.getAttribute('data-open-modal')
      openModal(id)
      return
    }

    const closeBtn = e.target.closest('[data-close]')
    if (closeBtn) {
      const modal = closeBtn.closest('[data-modal-id]')
      if (modal) closeModal(modal)
      return
    }

    const backdrop = e.target.closest('[data-backdrop]')
    if (backdrop) {
      const modal = backdrop.closest('[data-modal-id]')
      if (modal) closeModal(modal)
      return
    }
  })

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      document.querySelectorAll('[data-modal-id]:not(.hidden)').forEach((modal) => {
        closeModal(modal)
      })
    }
  })
</script>
